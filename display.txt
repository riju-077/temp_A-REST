# deep_q_display_query_rewrite.py
# Modified deep_q_display() SQL query — adds 3 new columns:
#   TOS_LAST_HOUR_IMP, PP_LAST_HOUR_IMP, ROS_LAST_HOUR_IMP
# NEW: LAST_HOUR_IMP CTE + 3 LEFT JOINs in FINAL_TAB + 3 columns in SELECT
# NOTE: AS_SD_TRAFFIC doesn't have PLACEMENT column yet — will be added later.

    sql_data = qcm.fetch(
        f"""
DECLARE @NOW DATETIME = '{pst_time_str()}',
	@INTERVAL INT = {interval},
	@MONITOR BIT = {int(monitor)};
DECLARE @STARTOFHOUR DATETIME2 = CAST(FORMAT(@NOW, 'yyyy-MM-dd HH:00') AS DATETIME2);
DECLARE @CVRDAYCOUNT INT = (SELECT MAX(CVRDAYCOUNT) FROM MODELING_DB.DBO.Q_MASTER
    WHERE DEEPQSWITCH = 1 AND CAMPAIGNTYPE = 'SD');

WITH MAIN_TAB AS (
        SELECT * FROM MODELING_DB.DBO.Q_MASTER
        WHERE DEEPQSWITCH = 1 AND CAMPAIGNTYPE = 'SD'),
KEY_TAB AS (
        SELECT * FROM MODELING_DB.DBO.KEYWORDS_FOR_AGENT
        WHERE CAMPAIGNID IN (SELECT CAMPAIGNID FROM MAIN_TAB)),
SQS_TAB AS (
	SELECT CAMPAIGN_ID, TARGET_ID, CLICKS, IMPRESSIONS, COST, DATATIME
	FROM [AMAZON_ANALYTICS].[DBO].AS_SD_TRAFFIC
	WHERE CAST(TIME_WINDOW_START AS DATE) = CAST(@NOW AS DATE)
		AND DATATIME <= @NOW AND CAMPAIGN_ID IN (SELECT CAMPAIGNID FROM MAIN_TAB)
	),
CURR_TAB AS (
	SELECT TARGET_ID, SUM(CLICKS) CLK0, SUM(IMPRESSIONS) IMP0,  SUM(CAST(COST AS FLOAT)) COST0,
		CASE WHEN SUM(CLICKS) = 0 THEN 0
		ELSE CAST(SUM(COST) AS FLOAT)/SUM(CLICKS) END AS CPC,
        CASE WHEN SUM(IMPRESSIONS) = 0 THEN 0
            WHEN SUM(IMPRESSIONS) > 0 AND SUM(CLICKS) <= 0 THEN (1.0/SUM(IMPRESSIONS) - 1)
        ELSE CAST(SUM(CLICKS) AS FLOAT)/SUM(IMPRESSIONS) END AS CTR0
        FROM SQS_TAB GROUP BY TARGET_ID),
PREV_TAB AS (
        SELECT TARGET_ID, SUM(CLICKS) CLK1, SUM(IMPRESSIONS) IMP1,
		CASE WHEN SUM(CLICKS) = 0 THEN 0
		ELSE CAST(SUM(COST) AS FLOAT)/SUM(CLICKS) END AS CPC1,
            CASE WHEN SUM(IMPRESSIONS) = 0 THEN 0 WHEN SUM(IMPRESSIONS) > 0 AND SUM(CLICKS) <= 0 THEN (1.0/SUM(IMPRESSIONS) - 1)
        ELSE CAST(SUM(CLICKS) AS FLOAT)/SUM(IMPRESSIONS) END AS CTR1
        FROM SQS_TAB WHERE DATATIME <= DATEADD(MINUTE, -@INTERVAL, @NOW)
        GROUP BY TARGET_ID),
TOTAL_CLICK_TAB AS (
		SELECT TARGET_ID, SUM(CLICKS) AS CLICKS FROM [AMAZON_ANALYTICS].[DBO].AS_SD_TRAFFIC
		WHERE CAST(TIME_WINDOW_START AS DATETIME2) >= DATEADD(HOUR, -@CVRDAYCOUNT, @NOW) AND CAST(DATATIME AS DATE) <= @NOW
			AND CAMPAIGN_ID IN (SELECT CAMPAIGNID FROM MAIN_TAB)
		GROUP BY TARGET_ID),
TOTAL_CONV_TAB AS (
		SELECT TARGET_ID, SUM(ATTRIBUTED_CONVERSIONS_14D) AS CONVERSION FROM [AMAZON_ANALYTICS].[DBO].AS_SD_CONVERSION
		WHERE CAST(TIME_WINDOW_START AS DATETIME2) >= DATEADD(HOUR, -@CVRDAYCOUNT, @NOW) AND CAST(DATATIME AS DATE) <= @NOW
			AND CAMPAIGN_ID IN (SELECT CAMPAIGNID FROM MAIN_TAB)
		GROUP BY TARGET_ID),
CONV_TAB AS (
		SELECT SUM(CONVERSION) AS UNITS
		FROM (
			SELECT ISNULL(ORDERCOUNT - LAG(ORDERCOUNT) OVER (PARTITION BY CAST(TIMESTAMP AS DATE) ORDER BY TIMESTAMP), 0) AS CONVERSION
			FROM [AMAZON_MARKETING].[DBO].[AMZN_SALES_DATA]
			WHERE TIMESTAMP >= DATEADD(HOUR, -1, @STARTOFHOUR)
			  AND TIMESTAMP <= @NOW
		) AS TAB),
LATEST_CPC_TAB AS (
	SELECT TARGET_ID, MAX(DATATIME) LATEST
	FROM SQS_TAB WHERE COST > 0 GROUP BY TARGET_ID),
CPC_CURR_TAB AS(
	SELECT ST.TARGET_ID, SUM(CAST(ST.COST AS FLOAT)) / SUM(ST.CLICKS) AS CPC FROM
	SQS_TAB ST JOIN LATEST_CPC_TAB LCT ON ST.TARGET_ID = LCT.TARGET_ID AND ST.DATATIME = LCT.LATEST AND ST.CLICKS > 0
	GROUP BY ST.TARGET_ID
	),
CPC_PREV_TAB AS(
	SELECT ST.TARGET_ID, SUM(CAST(ST.COST AS FLOAT)) / SUM(ST.CLICKS) AS CPC FROM
	SQS_TAB ST JOIN(
		SELECT ST.TARGET_ID, MAX(ST.DATATIME) PREV
		FROM SQS_TAB ST JOIN LATEST_CPC_TAB LCT
			ON ST.TARGET_ID=LCT.TARGET_ID AND ST.DATATIME < LCT.LATEST AND ST.COST > 0 AND ST.CLICKS > 0
		GROUP BY ST.TARGET_ID
	) PCT ON ST.TARGET_ID = PCT.TARGET_ID AND ST.DATATIME = PCT.PREV
	GROUP BY ST.TARGET_ID),
COST_TAB AS (
	SELECT CAMPAIGN_ID, SUM(CAST(COST AS FLOAT)) COST FROM SQS_TAB GROUP BY CAMPAIGN_ID),
KEY_CONV_TAB AS (
	SELECT TARGET_ID AS KEYWORDID , SUM(ATTRIBUTED_CONVERSIONS_14D) AS CONV FROM [AMAZON_ANALYTICS].[DBO].AS_SD_CONVERSION
		WHERE CAST(TIME_WINDOW_START AS DATE) >= CAST(@NOW AS DATE) AND DATATIME <= @NOW
			AND CAMPAIGN_ID IN (SELECT CAMPAIGNID FROM MAIN_TAB)
	GROUP BY TARGET_ID),
PREV_KEY_CONV_TAB AS (
	SELECT TARGET_ID AS KEYWORDID , SUM(ATTRIBUTED_CONVERSIONS_14D) AS PREV_CONV FROM [AMAZON_ANALYTICS].[DBO].AS_SD_CONVERSION
		WHERE CAST(TIME_WINDOW_START AS DATE) >= CAST(@NOW AS DATE) AND DATATIME <=  DATEADD(MINUTE, -@INTERVAL, @NOW)
			AND CAMPAIGN_ID IN (SELECT CAMPAIGNID FROM MAIN_TAB)
	GROUP BY TARGET_ID),
LAST_HOUR_IMP AS (
	SELECT TARGET_ID, PLACEMENT, SUM(IMPRESSIONS) AS L_HOUR_IMP
	FROM [AMAZON_ANALYTICS].[DBO].AS_SD_TRAFFIC
	WHERE CAST(TIME_WINDOW_START AS DATETIME2) >= DATEADD(HOUR, -1, @NOW)
		AND DATATIME <= @NOW
		AND CAMPAIGN_ID IN (SELECT CAMPAIGNID FROM MAIN_TAB)
	GROUP BY TARGET_ID, PLACEMENT
	),
FINAL_TAB AS (
	SELECT KT.KEYWORDID, KT.CAMPAIGNID, KT.ADGROUPID, MT.GAMMA, MT.LR, MT.EPSTART, MT.BASEBIDLOWER, MT.BASEBIDUPPER, MT.COMBINEDDEEPQSWITCH,
		MT.CVRFLAG, MT.CLICKSTEP, CASE WHEN TCV.CONVERSION>0 THEN CAST (TCLK.CLICKS AS FLOAT) / TCV.CONVERSION ELSE 0 END CVR,
        MT.CTRWEIGHT, MT.CONVWEIGHT, MT.CVRWEIGHT, MT.WEIGHTFLAG, MT.CPCWEIGHT, MT.BUDGETWEIGHT, MT.DYNAMICEXPLORE,
        MT.BOLTZFLAG, MT.TDECAY,
		ISNULL(ROUND(CT.CTR0,4),0) AS CURR_CTR,
		ROUND(ISNULL(CT.CTR0, 0) - ISNULL(PT.CTR1, 0), 4) AS DELTA_CTR,
		ISNULL(ROUND(CT.CPC,2),0) AS CPC, ISNULL(ROUND(PT.CPC1,2),0) AS CPC1, ISNULL(CVT.UNITS,0) UNITS,
        ISNULL(CCT.CPC, 0) CURR_CPC, ISNULL(CPT.CPC, 0) PREV_CPC,  ISNULL(CST.COST,0) SPENTBUDGET, ISNULL(KCT.CONV,0) CONV,
		ISNULL(PKCT.PREV_CONV,0) PREV_CONV, ISNULL(PT.CLK1,0) PREV_CLICK, ISNULL(CT.CLK0,0) CLICK, ISNULL(CT.COST0,0) COST,
		ISNULL(PP_T.L_HOUR_IMP, 0) PP_LAST_HOUR_IMP, ISNULL(TOS_T.L_HOUR_IMP, 0) TOS_LAST_HOUR_IMP, ISNULL(ROS_T.L_HOUR_IMP, 0) ROS_LAST_HOUR_IMP
	FROM KEY_TAB KT LEFT JOIN CURR_TAB CT ON KT.KEYWORDID = CT.TARGET_ID
		LEFT JOIN MAIN_TAB MT ON KT.CAMPAIGNID = MT.CAMPAIGNID
		LEFT JOIN PREV_TAB PT ON KT.KEYWORDID = PT.TARGET_ID
		LEFT JOIN TOTAL_CLICK_TAB TCLK ON KT.KEYWORDID = TCLK.TARGET_ID
		LEFT JOIN TOTAL_CONV_TAB TCV ON KT.KEYWORDID = TCV.TARGET_ID
        LEFT JOIN CPC_CURR_TAB CCT ON KT.KEYWORDID = CCT.TARGET_ID
		LEFT JOIN CPC_PREV_TAB CPT ON KT.KEYWORDID = CPT.TARGET_ID
		LEFT JOIN COST_TAB CST ON KT.CAMPAIGNID = CST.CAMPAIGN_ID
		LEFT JOIN KEY_CONV_TAB KCT ON KT.KEYWORDID = KCT.KEYWORDID
        LEFT JOIN PREV_KEY_CONV_TAB PKCT ON KT.KEYWORDID = PKCT.KEYWORDID
        LEFT JOIN CONV_TAB CVT ON 1=1
		LEFT JOIN (SELECT * FROM LAST_HOUR_IMP WHERE PLACEMENT='DETAIL PAGE ON-AMAZON')PP_T ON KT.KEYWORDID=PP_T.TARGET_ID
		LEFT JOIN (SELECT * FROM LAST_HOUR_IMP WHERE PLACEMENT='TOP OF SEARCH ON-AMAZON')TOS_T ON KT.KEYWORDID=TOS_T.TARGET_ID
		LEFT JOIN (SELECT * FROM LAST_HOUR_IMP WHERE PLACEMENT='OTHER ON-AMAZON')ROS_T ON KT.KEYWORDID=ROS_T.TARGET_ID)
SELECT * FROM FINAL_TAB
WHERE @MONITOR = 0 OR DELTA_CTR <= 0 --OR CPC <> CPC1
"""
    )
